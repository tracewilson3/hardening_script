#!/bin/bash

# ================================
# Harden Apache Web Server
# ================================
echo "ğŸ”’ Hardening Apache configuration..."

# Prevent Apache from displaying server information
sed -i 's/^ServerTokens OS/ServerTokens Prod/' /etc/apache2/conf-available/security.conf
sed -i 's/^ServerSignature On/ServerSignature Off/' /etc/apache2/conf-available/security.conf

# Disable directory listing
sed -i 's/Options Indexes FollowSymLinks/Options -Indexes +FollowSymLinks/' /etc/apache2/apache2.conf

# Restart Apache to apply changes
service restart apache2

echo "âœ… Apache has been hardened."

# ================================
# Change SSH Port and Disable Root Login
# ================================
echo "ğŸ”’ Changing SSH Port to 2222 and disabling root login..."

# Modify SSH config
sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# Restart SSH
systemctl restart sshd

echo "âœ… SSH port changed to 2222 and root login disabled."

# ================================
# Install and Configure Fail2Ban
# ================================
echo "ğŸ›¡ï¸ Installing Fail2Ban..."

apt-get update -y
apt-get install -y fail2ban

# Create custom Fail2Ban jail for SSH
cat <<EOL > /etc/fail2ban/jail.local
[sshd]
enabled = true
port    = 2222
maxretry = 5
findtime = 600
bantime = 3600
EOL

# Restart Fail2Ban
systemctl restart fail2ban

echo "âœ… Fail2Ban installed and configured."

# ================================
# Close all unused ports
# ================================
echo "ğŸš§ Closing all unused ports..."

# Allow only HTTP, HTTPS, and SSH (2222)
ufw default deny incoming
ufw default allow outgoing
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
ufw allow 2222/tcp # SSH

# Enable firewall
ufw --force enable

echo "âœ… Firewall configured to allow only HTTP, HTTPS, and SSH."

# ================================
# Disable uncommon services
# ================================
echo "ğŸ”¥ Disabling unnecessary services..."

service stop avahi-daemon
service disable avahi-daemon

service stop cups
service disable cups

service stop nfs-server
service disable nfs-server

echo "âœ… Disabled unnecessary services."

# ================================
# Final Steps
# ================================
echo "âœ… All hardening complete!"
echo "ğŸš€ Your server is now hardened and locked down."
echo "ğŸ‘‰ Remember to connect via SSH like this:"
echo "    ssh -p 2222 <username>@<server-ip>"
